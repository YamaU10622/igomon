# X認証連携仕様書

## 概要
igomon（囲碁問題アンケートサイト）にX（旧Twitter）アカウントによるOAuth認証機能を追加する。

## 認証方式
- X OAuth 1.0a を使用（フリープランでの制限を回避するため）
- CSRFトークンはOAuthの仕組み内で対応

### 利用プランとコスト
- **X API Free tier**（月額0円）の "Login with X" 機能を使用
- 認証系エンドポイントのため**Read枠（100 reads/月）を消費しない**
- 無料で無制限にログイン可能（レート制限: 15分あたり900回程度）

### APIエンドポイント
1. `POST oauth/request_token` - リクエストトークン取得
2. `GET oauth/authenticate` - ユーザー認証画面
3. `POST oauth/access_token` - アクセストークン取得

### 取得できる情報
`oauth/access_token`のレスポンスに以下が自動的に含まれる：
- `user_id`: XのユーザーID
- `screen_name`: Xのユーザー名
- `oauth_token`: アクセストークン
- `oauth_token_secret`: トークンシークレット

**追加のAPI呼び出しは不要**（`/users/me`等を呼ぶ必要なし）

## 主要な変更点

### 1. 認証システムの変更
- **現在**: 自動生成トークンによる認証（初回アクセス時に自動的にユーザー作成）
- **変更後**: X OAuth認証のみ（既存の自動トークン認証は廃止）

### 2. ページごとのアクセス制御

| ページ | ログイン要否 | 備考 |
|--------|--------------|------|
| トップページ（問題一覧） | 不要 | ログインなしで閲覧可能 |
| 回答ページ | 不要（閲覧時）<br>必要（送信時） | 問題と盤面は閲覧可能<br>送信ボタンクリック時にログイン要求 |
| 結果ページ | 必要 | 期限切れ・回答済みに関わらずログイン必須 |

### 3. データベース設計の変更

#### usersテーブルの更新
既存のusersテーブルに以下のフィールドを追加：
- `xUserId`: X（Twitter）のユーザーID（必須）
  - ユーザーの一意識別子として使用
  - 同じXアカウントでの重複ログインを防ぐ
- `xScreenName`: Xのユーザー名
- `xOauthToken`: OAuth 1.0aのアクセストークン
- `xOauthTokenSecret`: OAuth 1.0aのトークンシークレット

#### userProfilesテーブルの新規作成
ユーザープロファイル情報を管理：
- `userId`: usersテーブルへの外部キー
- `name`: ユーザー名
- `rank`: 段位
- その他必要なプロファイル情報

### 4. 回答フローの変更

#### 未ログイン時の回答フロー
1. ユーザーが回答ページで問題を閲覧
2. 回答内容（座標、理由、名前、段位）を入力
3. 送信ボタンをクリック
4. 入力データをlocalStorageに一時保存
5. X OAuth認証画面へリダイレクト
6. 認証完了後、回答ページへ戻る
7. ユーザーの回答状態を確認：
   - **未回答**: 一時保存データを使用して回答を保存 → 結果ページへ遷移
   - **回答済み**: 一時保存データを破棄 → 結果ページへ遷移

#### ログイン済みの回答フロー
1. 回答ページアクセス時に回答済みチェック
2. **回答済み**: 結果ページへ自動リダイレクト
3. **未回答**: 通常通り回答可能

### 5. UI/UXの変更

#### ログインリンクの追加
- トップページと回答ページの右上にログインリンクを配置
- ログインリンクをクリックするとX OAuth認証のみ実行（その他の処理なし）

#### ログイン状態の表示
- ユーザー名等の表示は不要（ログイン状態の視覚的表示なし）

### 6. 初回ログイン時の処理

回答ページから初めてXアカウントでログインした場合：
1. X OAuth認証完了
2. usersテーブルに新規ユーザー作成（xId、アクセストークン等を保存）
3. 入力された名前と段位をuserProfilesテーブルに保存
4. 回答データを保存
5. 結果ページへ遷移

### 7. コールバックURL

OAuth 1.0aではコールバックURLをアプリケーション設定とリクエスト時の両方で指定：
- 本番環境: `https://igomon.net/auth/callback`
- 開発環境: `http://localhost:5173/auth/callback`（ポート番号は環境に応じて調整）

## セキュリティ考慮事項

1. **CSRF対策**: OAuth 1.0aの署名メカニズムで対応
2. **トークンシークレット**: データベースに安全に保存
3. **HTTPS**: 本番環境では必須
4. **署名検証**: すべてのリクエストで署名を検証

## 実装順序（参考）

1. データベーススキーマの更新（users、userProfilesテーブル）
2. X OAuth 1.0a認証の実装（エンドポイント、ミドルウェア）
3. 既存の認証システムの置き換え
4. UI更新（ログインリンク追加、フロー変更）
5. 回答データの一時保存機能
6. テストとデバッグ

## 推奨ライブラリ

- **passport-twitter**: Express用の定番OAuth 1.0a実装
- **node-oauth**: 低レベルのOAuth 1.0a実装が必要な場合
- セッション管理は既存の`express-session`を活用

## 注意事項

- 既存ユーザーデータの移行は行わない
- X APIの利用にはX Developer Accountの作成とアプリケーション登録が必要
- OAuth 1.0aではConsumer KeyとConsumer Secretが必要
- レート制限（15分900回）に注意するが、認証用途では十分な回数