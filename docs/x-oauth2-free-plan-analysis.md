# X (Twitter) OAuth 2.0 Freeプラン実現可能性分析

このドキュメントは、X(旧Twitter)のOAuth 2.0（PKCE）を使用してWebアプリ（igomon.net）に認証機能のみを実装する場合に、Freeプランで実現可能かどうかを調査・分析した結果をまとめたものです。

## 調査概要

- **対象**: X OAuth 2.0 (PKCE) 認証
- **用途**: Webアプリでの認証機能のみ（ユーザー情報取得なし）
- **プラン**: X API v2 Freeプラン
- **目的**: igomon.netへの「Xでログイン」機能実装

## 1. FreeプランでPKCE認証の可否

X（旧Twitter）の開発者向けドキュメントでは、FreeプランでもOAuth 2.0（PKCE）によるユーザー認証が明記されています。Freeプランは開発者アカウント取得者に無料で提供され、ユーザー認証には「OAuth 2.0 with PKCE」と「アプリ専用認証（App-only）」が使えます。したがって、FreeプランでもOAuth 2.0（PKCE）認証フローを利用して「Xでログイン」を実装できます。

## 2. 認証のみ利用時のレート制限

純粋に認証だけ（ツイートやユーザー情報の取得を行わない）場合、X API v2の通常のツイート取得制限（「Tweet消費上限」）は消費しません。Freeプランで利用できるエンドポイントは投稿（ツイート）関連と、OAuthユーザー認証に必要な GET /2/users/me のみです。特に、**`GET /2/users/me`** はFreeプランで利用可能で、ユーザー当たり1日最大25リクエスト（15分間あたり最大75リクエスト）の制限があります。OAuth2トークン取得（POST /oauth2/token）も独自のレート制限（ユーザーあたり30分100回程度）がありますが、これはツイート取得とは別枠です。まとめると、認証フロー中に行う /2/oauth2/token や /2/users/me といった呼び出しはそれぞれ個別のレート制限下にあります。ただし「ツイート取得上限」の対象ではないため、**認証のみであれば通常の「読み取り上限」は消費しません**。

## 3. トークンに含まれるユーザー識別子

X APIのOAuth2認可コード＋PKCEフローでは、**トークン取得時のレスポンスにユーザーID (sub) は含まれません**。公式ドキュメントの例を見る限り、`access_token` や `refresh_token` のほかにユーザー情報は返ってこず、ユーザー識別には GET /2/users/me エンドポイントを呼び出す必要があります。つまり、取得した access_token だけではユーザーを特定できないため、ユーザーIDやスクリーンネームを紐づけるには `GET /2/users/me`（必要なスコープ：`users.read`）を別途呼び出してください。

## 4. 実装・申請時の設定と注意点

- **アプリ登録・認証設定**：開発者ポータルで新しいProject/Appを作成し、Appの「認証設定」でOAuth 2.0を有効化します。OAuth2を選択するとClient IDが発行され、必要に応じてRedirect URI（コールバックURL）を登録します。
- **アプリ種別とクライアント種別**：アプリ種別として「Web App」を選ぶと機密クライアント（クライアントシークレットを保持）になります。ドキュメントにあるとおり、「Web App／Automated App」は機密クライアントでクライアントシークレットが発行され、「Single Page／Native App」は公開クライアント（シークレットなし）です。Webアプリの場合、token取得時はクライアントシークレットをBasic認証ヘッダに含めて送信するなど安全に管理します。
- **スコープ設定**：認可時に必要最低限のスコープ（例：`users.read`）を指定します。ログインだけであればツイート取得系スコープは不要です。必要に応じて `offline.access` を含めるとリフレッシュトークンも発行されます（リフレッシュトークンなしではアクセストークンの有効期限はデフォルトで2時間）。
- **プラン上の制限**：Freeプランでは1プロジェクトにつきアプリは1つまで作成可能です。また、英語の開発者ポータルで入力する目的や利用ケースは適切に設定・最新化しておきましょう。

## 5. WebアプリでPKCEを使う際の制約

PKCEはもともとネイティブやSPA向けに設計されていますが、X APIではWebアプリ（機密クライアント）でも同様にPKCEフローを利用できます。公式ガイドでも「機密クライアント向けの例」としてBasic認証ヘッダを用いたトークンリクエスト例が示されています。つまりWebアプリでは次のように扱います：`code_challenge` と `code_verifier` を生成しつつ、クライアントシークレットを安全に保持してトークン取得時にBasic認証で送信します。PKCEを使うか否かは厳密な制約はなく、クライアントがシークレットを持つかどうかでフローが変わるだけです。まとめると、Webアプリでも公式ドキュメントに沿ってPKCEフローを実装すれば問題なく動作します。

## まとめ

X API v2のFreeプランを使用して、igomon.netに「Xでログイン」機能を実装することは**十分に実現可能**です。

### 実現可能な理由

- OAuth 2.0 (PKCE) 認証はFreeプランで利用可能
- 認証のみであれば主要なレート制限の対象外
- WebアプリでもPKCEフローが公式サポート済み

### 注意点

- ユーザー識別には`GET /2/users/me`の呼び出しが必要
- クライアントシークレットの適切な管理が必要
- 必要最小限のスコープ設定が推奨

**参考資料:** X公式ドキュメント (X API認証・レート制限の最新情報)
